<!doctype html>
<html>

<head>
  <title>404 Not Found</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
  <base target="_blank">
  <style>
    body {
      padding: 0 0.5em;
    }

    .box {
      margin-top: 1em;
    }

    #txtURL {
      width: 100%;
      height: 2em;
      text-indent: 0.5em;
      padding: 0.25em 0;
    }

    #btnGo {
      width: 100%;
      font-size: 1.5em;
    }

    #list a {
      margin: 1em;
    }
  </style>
</head>

<body>
  <img src="https://sys.4chan.org/image/error/404/rid.php" referrerpolicy="no-referrer" alt="404 Not Found"
    style="pointer-events: none;" />
  <div class="box">
    <input id="txtURL" type="text" value="www.whatismyproxy.com" autofocus>
  </div>
  <div class="box">
    <button id="btnGo">FREEDOM IS NOT FREE</button>
  </div>
  <div class="box">
    <span>choice:</span>
    <select id="selNode"></select>
  </div>
  <div class="box" id="list">
  </div>
  <script>
    const PAGE_CONF_SET = 110
    const PAGE_CONF_GET = 111

    const SW_CONF_RETURN = 112
    const SW_CONF_CHANGE = 113

    const PAGE_READY_CHECK = 200
    const SW_READY = 201

    const sw = navigator.serviceWorker


    sw.addEventListener('message', onSwMsg)
    sendMsgToSw(PAGE_READY_CHECK)

    btnGo.onclick = function () {
      const text = txtURL.value.trim()
      if (text) {
        const url = './-----' + text
        open(url, '_blank', 'noopener,noreferrer')
      }
    }
    txtURL.onkeypress = function (e) {
      if (e.keyCode === 13) {
        btnGo.onclick()
      }
    }
    txtURL.setSelectionRange(0, txtURL.value.length)


    function onSwMsg(e) {
      const [cmd, msg] = e.data

      switch (cmd) {
        case SW_CONF_RETURN:
          conf = msg
          showConf()
          break

        case SW_CONF_CHANGE:
          conf = msg
          updateSelected()
          break

        case SW_READY:
          console.log('sw ready')
          showIcons()
          sendMsgToSw(PAGE_CONF_GET)
          break
      }
    }

    function onSwFail(err) {
      txtURL.value = err
    }

    selNode.onchange = function () {
      const item = this.options[this.selectedIndex]
      const node = item.value
      conf.node_default = node
      sendMsgToSw(PAGE_CONF_SET, conf)
    }

    function sendMsgToSw(cmd, val) {
      const ctl = sw.controller
      if (!ctl) {
        console.log('ctl is null')
        return
      }
      ctl.postMessage([cmd, val])
    }

    function shuffle(array) {
      let currentIndex = array.length,  randomIndex;
      // While there remain elements to shuffle.
      while (currentIndex > 0) {
        // Pick a remaining element.
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }
      return array;
    }
    
    // // Used like so
    // var arr = [2, 11, 37, 42];
    // shuffle(arr);
    // console.log(arr);
    
    const SITE_LIST = [
      ['4get', 'farside.link/4get'],
      ['anonymousoverflow', 'farside.link/anonymousoverflow'],
      ['archive', 'web.archive.org/'],
      ['bibliogram', 'farside.link/bibliogram'],
      ['bing', 'www.bing.com/new'],
      ['blogger', 'micmic20220601.blogspot.com'],
      ['breezewiki', 'farside.link/breezewiki'],
      ['browserleaks', 'browserleaks.com/dns'],
      ['browserleaks', 'browserleaks.com/webrtc'],
      ['cloudflare', 'cloudflare.com/cdn-cgi/trace'],
      ['deepl', 'farside.link/lingval'],
      ['duckduckgo', 'duckduckgo.com/?kae=t&kp=-2&kn=1&kaj=m&kay=b&kak=-1&kax=-1&kaq=-1&kap=-1&kao=-1&k5=1'],
      ['dumb', 'farside.link/dumb'],
      ['exhentai', 'exhentai.org'],
      ['facebook', 'facebook.com/zuck'],
      ['fdroid', 'f-droid.org'],
      ['flagfox', 'iplookup.flagfox.net'],
      ['flickr', 'www.flickr.com/photos/gedawei'],
      ['freebrowser', 'startpage.freebrowser.org'],
      ['freeopenvpn', 'www.freeopenvpn.org'],
      ['freevpn4you', 'freevpn4you.net'],
      ['freewechat', 'freewechat.com/'],
      ['freeweibo', 'freeweibo.com/'],
      ['gfwreport', 'gfw.report'],
      ['gist', 'gist.github.com/madeye'],
      ['github', 'github.com/trending'],
      ['google', 'g.kfd.me'],
      ['google', 'www.google.com/ncr'],
      ['gothub', 'farside.link/gothub'],
      ['greatfire', 'greatfire.org/analyzer'],
      ['hanime', 'hanime.tv'],
      ['he', 'bgp.he.net'],
      ['he', 'icors.vercel.app/?https://bgp.he.net'],
      ['healthcode', 'ilovexjp.pages.dev'],
      ['iknowwhatyoudownload', 'iknowwhatyoudownload.com/en/peer/'],
      ['invidious', 'farside.link/invidious'],
      ['invidious', 'youtube.076.ne.jp'],
      ['ipfs', 'gateway.pinata.cloud/ipns/libgen.crypto'],
      ['ipfs', 'ipfs.github.io/public-gateway-checker'],
      ['izzysoft', 'apt.izzysoft.de/fdroid'],
      ['kagi', 'kagi.com'],
      ['librarian', 'farside.link/librarian'],
      ['libreddit', 'farside.link/libreddit'],
      ['libremdb', 'farside.link/libremdb'],
      ['librex', 'farside.link/librex'],
      ['librey', 'farside.link/librey'],
      ['lihkg', 'lihkg.com'],
      ['lingva', 'farside.link/lingva'],
      ['lingva', 'lingva.ml'],
      ['mastodon', 'mastodon.social/@Z_Lib_official'],
      ['micmicidol', 'www.micmicidol.club'],
      ['nhentai', 'nhentai.net'],
      ['nicovideo', 'www.nicovideo.jp/ranking/genre/anime?term=month'],
      ['nitter', 'farside.link/https://twitter.com/gfw_report/with_replies'],
      ['nitter', 'farside.link/nitter'],
      ['nyaa', 'nyaa.si/user/BlueLobster'],
      ['pawoo', 'pawoo.net/@Misekai'],
      ['piped', 'farside.link/piped'],
      ['pixiv', 'www.pixiv.net/users/216403'],
      ['proxitok', 'farside.link/proxitok'],
      ['quetre', 'farside.link/quetre'],
      ['reddit', 'farside.link/old.reddit.com/r/popular'],
      ['rimgo', 'farside.link/rimgo'],
      ['scribe', 'farside.link/scribe'],
      ['searx', 'farside.link/searx'],
      ['searxng', 'farside.link/searxng'],
      ['seeip', 'ip.seeip.org/geoip'],
      ['simplytranslate', 'farside.link/simplytranslate'],
      ['startpage-dark', 'www.startpage.com/do/mypage.pl?prfe=e1d14ecae9f99f9cf658718d22b59abe37104517186a70b70397347d0d8e4b7f7f467ef0641e91aa412764d43b3dcc60f5a73c66717a165e471ce878c99aa8aa315479729b9b150076480d4a2108'],
      ['startpage-light', 'www.startpage.com/do/mypage.pl?prfe=e25512658d454387249a6bb25c05db7986c909a614623aaac8b8ea00c0e9e1786c4a2369a00b4d9894909fe306f16a6382686748cae0ea9fcbf3b1e0d39bf9a6c6db014fd07e845b1ca40129811b'],
      ['teddit', 'farside.link/teddit'],
      ['telegram', 't.me/s/onessr'],
      ['torproject', 'bridges.torproject.org/bridges?transport=obfs4'],
      ['torproject', 'metrics.torproject.org/userstats-bridge-country.html?country=cn'],
      ['twitch', 'www.twitch.tv'],
      ['v2ex', 'www.v2ex.com/?tab=hot'],
      ['wanqu', 'www.wanqu.co'],
      ['whois', 'who.is'],
      ['whoogle', 'farside.link/whoogle'],
      ['wikiless', 'farside.link/wikiless'],
      ['yahoo', 'www.yahoo.com'],
      ['youtube', 'www.youtube.com/user/LastWeekTonight/videos'],
          ]
  
    shuffle(SITE_LIST);

    function showIcons() {
      list.innerHTML = SITE_LIST.map(v => {
        let [id, url] = v
        url = url || `www.${id}.com/`
        return `\
<a rel="noopener noreferrer" href=./-----https://${url}>\
<img width=128 height=128 src=__sys__/assets/ico/${id}.png></a>`
      }).join('')
    }

    function addNodeItem(id, text) {
      const optEl = document.createElement('option')
      optEl.id = '--' + id
      optEl.text = text
      optEl.value = id
      selNode.appendChild(optEl)
    }

    function updateSelected() {
      const id = conf.node_default
      const item = document.getElementById('--' + id)
      if (item) {
        item.selected = true
      } else {
        console.warn('unknown node:', id)
      }
    }

    function showConf() {
      for (const [id, node] of Object.entries(conf.node_map)) {
        if (!node.hidden) {
          addNodeItem(id, node.label)
        }
      }
      updateSelected()
    }
  </script>
</body>

</html>
